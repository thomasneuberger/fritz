@page "/game"
@using FritzApp.Models
@using FritzApp.Services
@using FritzApp.Components
@using FritzApp.Resources
@using Microsoft.Extensions.Localization
@inject GameService GameService
@inject IStringLocalizer<Localizations> Localizer
@inject CultureService CultureService

<PageTitle>Fritz Game</PageTitle>

<div class="game-container">
    <h1 class="game-title">@Localizer["GameTitle"]</h1>
    
    <div class="status-message">
        @GameService.StatusMessage
    </div>

    <div class="game-board">
        @for (int row = 0; row < 5; row++)
        {
            int currentRow = row;
            <div class="board-row">
                @for (int col = 0; col < 5; col++)
                {
                    int currentCol = col;
                    var cell = GameService.Board[currentRow, currentCol];
                    <button class="cell @GetCellClass(cell)" 
                            @onclick="() => OnCellClick(currentRow, currentCol)"
                            disabled="@IsGameOver()">
                        @GetCellContent(cell)
                    </button>
                }
            </div>
        }
    </div>

    <div class="button-container">
        <button class="new-game-btn" @onclick="NewGame">@Localizer["NewGame"]</button>
        <button class="rules-btn" @onclick="ShowRules">@Localizer["Rules"]</button>
        <button class="qr-code-btn" @onclick="ShowQrCode">@Localizer["QrCode"]</button>
        <LanguageSelector />
    </div>
</div>

<QrCodeDialog IsVisible="@showQrDialog" IsVisibleChanged="@((value) => showQrDialog = value)" />
<RulesDialog IsVisible="@showRulesDialog" IsVisibleChanged="@((value) => showRulesDialog = value)" />

@code {
    private bool showQrDialog = false;
    private bool showRulesDialog = false;

    protected override void OnInitialized()
    {
        GameService.NewGame();
    }

    private void OnCellClick(int row, int col)
    {
        GameService.MakeMove(row, col);
        StateHasChanged();
    }

    private void NewGame()
    {
        GameService.NewGame();
        StateHasChanged();
    }

    private void ShowQrCode()
    {
        showQrDialog = true;
        StateHasChanged();
    }

    private void ShowRules()
    {
        showRulesDialog = true;
        StateHasChanged();
    }

    private string GetCellContent(Cell cell)
    {
        return cell.Player switch
        {
            Player.X => "✕",
            Player.O => "◯",
            _ => ""
        };
    }

    private string GetCellClass(Cell cell)
    {
        return cell.Player switch
        {
            Player.X => "cell-x",
            Player.O => "cell-o",
            _ => "cell-empty"
        };
    }

    private bool IsGameOver()
    {
        return GameService.State == GameState.GameOver;
    }
}
